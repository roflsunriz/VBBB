# 汎用掲示板ブラウザ 実装契約（ソース非参照前提）

> 目的: `bbs-browser-protocol-reference.md` と `bbs-browser-advanced-features.md` だけで実装する際に、曖昧さを減らし、同等実装を再現可能にするための規範仕様（MUST/SHOULD）と受け入れ基準を定義する。

---

## 1. この文書の適用範囲

- 本文書は、既存2ドキュメントの不足分（規範性、異常系、テスト可能性）を補う。
- 優先順位は以下とする:
  1. 本文書（実装契約）
  2. `bbs-browser-protocol-reference.md`
  3. `bbs-browser-advanced-features.md`
- 相反がある場合は本文書を優先し、差分は ADR または追補で記録する。

---

## 2. 実装レベル定義（Definition of Done）

### 2.1 MVP 必須要件（MUST）

- 板一覧取得: HTML パースして INI へ保存し、再起動後も再利用可能。
- `subject.txt` 取得: 200/304 を処理し、Age/Sage/New/Archive を決定可能。
- DAT 取得: 200/206/304/416 を処理し、16バイト重複チェックを実装。
- 投稿: `grtOK`/`grtCookie`/`grtCheck`/`grtError` を判定し再送可能。
- ローカル永続化: `Folder.idx`、Cookie 保存、Favorite 読み書きが相互整合。
- エンコーディング: 5ch/2ch（Shift_JIS中心）、JBBS/EUC-JP を読み書き可能。

### 2.2 推奨要件（SHOULD）

- 302（DAT落ち）時の kako/oyster フォールバック。
- Samba タイマー・NG あぼーん・スキンレンダリング。
- 外部板プラグイン（したらば/JBBS）の URL 差異吸収。

---

## 3. 規範仕様（MUST/SHOULD/ MAY）

### 3.1 HTTP 共通

- MUST: 全リクエストに `User-Agent` を付与する。
- MUST: 通信タイムアウトを設定する（接続/読込それぞれ設定可能）。
- MUST: 429/503 等の一時障害時は指数バックオフ（例: 1s, 2s, 4s, 最大30s）。
- SHOULD: `If-Modified-Since` を活用し帯域を節約する。
- MUST: Range 取得時は `Accept-Encoding: gzip` を送らない。

### 3.2 DAT 差分マージ

- MUST: `bytes={size-16}-` を使い、先頭16バイト重複を照合する。
- MUST: 不一致時は破損とみなし、Range なし全文 GET を1回実施する。
- MUST: 再取得失敗時は既存ローカル DAT を破棄せず、エラー通知して終了する。
- SHOULD: 比較時に `\r` 差異を吸収する。

### 3.3 投稿フロー

- MUST: `grtCookie`/`grtCheck` 時は hidden フィールドを抽出し再送する。
- MUST: 再送回数の上限を設定する（推奨: 2回）。
- MUST: 同一 payload の無限ループ再送を防止する（ハッシュ比較で抑止）。
- SHOULD: 投稿成功時に該当スレの即時再取得を試行する。

### 3.4 ローカルファイル I/O

- MUST: 文字コードと改行をファイル種別ごとに固定する。
- MUST: 書き込みはテンポラリファイル経由で原子的に置換する。
- MUST: 同時書き込みを禁止する（板単位またはファイル単位のロック）。
- SHOULD: 破損検知時は `.bak` を生成して復旧可能性を残す。

---

## 4. 文字コード・改行契約

| 対象 | 既定エンコーディング | 改行 | 備考 |
|---|---|---|---|
| `subject.txt`, `*.dat` (5ch/2ch) | Shift_JIS | LF | サーバー返却を尊重 |
| したらば/JBBS DAT | EUC-JP（必要時変換） | LF | パース時に内部UTF-8へ正規化可 |
| `Folder.idx` | Shift_JIS 相当（既存互換） | LF | 制御文字 `0x01` 区切り |
| `Favorite.xml` | Shift_JIS | LF | XML ヘッダと実体を一致させる |
| Markdown ドキュメント | UTF-8 (BOMなし) | LF | 開発資料用途 |

- MUST: 内部処理文字列は Unicode（UTF-16/UTF-8 いずれか）で統一する。
- MUST: ネットワーク入出力境界でのみエンコード/デコードする。

---

## 5. セキュリティ契約

- MUST: DAT/subject の文字列は HTML 表示前に無害化する。
- MUST: URL スキームを検証し、`javascript:` など危険スキームを拒否する。
- MUST: 外部プレビュー起動コマンドは固定テンプレート化し、URL を引数として安全に渡す。
- MUST: Cookie/認証情報はログに出力しない。
- SHOULD: CSP を有効化し、インラインスクリプト依存を減らす。
- SHOULD: `dangerouslySetInnerHTML` 相当が必要な場合はサニタイズライブラリを通す。

---

## 6. エラー処理マトリクス（最低限）

| 対象 | 条件 | 必須動作 |
|---|---|---|
| `subject.txt` | 304 | ローカルキャッシュ採用、最終取得時刻更新 |
| `subject.txt` | 404/5xx | UI に取得失敗を表示、既存キャッシュ維持 |
| DAT | 206 + 16B不一致 | 全文 GET にフォールバック |
| DAT | 416 | Range なしで再取得 |
| DAT | 302 | kako/oyster を順に試行 |
| 投稿 | `grtCookie`/`grtCheck` | hidden取得して再送（上限あり） |
| 投稿 | `grtDonguri` | 再投稿不可を通知し終了 |
| 投稿 | `grtError` | レスポンス本文を保存し診断可能にする |

---

## 7. 互換性と判定順序

### 7.1 Board 種別判定（MUST）

1. URL ホスト/パスで JBBS/したらばを先に判定する。
2. それ以外を 5ch/2ch 系として扱う。
3. 旧ドメイン（`*.2ch.net` 等）は正規化後に内部表現へ変換する。

### 7.2 URL 正規化（MUST）

- 末尾 `/` の有無を統一する。
- `http://` を `https://` に統一可能なら統一する。
- `itest` URL は PC 形式へ変換して保持する。

---

## 8. 受け入れテスト（最小セット）

### 8.1 パース検証（固定フィクスチャ）

- `subject.txt`:
  - 正常行（`<>`）
  - 旧形式（`,`）
  - レス数括弧バリエーション: `(123)`, `（123）`, `<123>`
- DAT:
  - 正常5フィールド
  - 末尾フィールド欠落
  - 本文空、CRLF混在
- URL:
  - PATH_INFO、QUERY_STRING、kako、itest

### 8.2 通信検証（モックサーバー）

- DAT: 200/206/302/304/416 の各分岐。
- 投稿: `grtOK`/`grtCookie`/`grtCheck`/`grtDonguri`/`grtError` の文字列判定。
- Cookie 永続化: 再起動後に必要 Cookie が復元される。

### 8.3 回帰検証（E2E）

- 板一覧更新 -> 板選択 -> スレ一覧 -> DAT 表示 -> 投稿 -> 再取得まで通しで成功する。
- NG あぼーん、Samba、お気に入り更新が機能衝突しない。

---

## 9. 実装時に未確定な論点（要調査）

- どんぐり関連の判定文字列は運用で変化する可能性が高い。
- dig.2ch.net 等の外部 API は将来利用不能になる可能性がある。
- 板ごとの投稿規制（SETTING.TXT の各種制限値）は実運用で厳密適用が必要な場合がある。

> これらは「仕様の欠落」ではなく「外部環境変動リスク」であり、実装では feature flag とフォールバック導線を設けること。

---

## 10. 変更管理ルール

- 本文書に影響する変更は、必ず「理由」「影響範囲」「後方互換性」を記録する。
- 既存挙動を変える変更は、受け入れテストケースを先に追加してから実装する。
- ドキュメント追記時は、既存2ドキュメントから本文書へのリンクが切れていないことを確認する。

